import sqlite3
from datetime import datetime


def create_database():
    """Создание базы данных и таблиц"""

    # Подключение к базе данных (создастся автоматически)
    conn = sqlite3.connect('../database.db')
    cursor = conn.cursor()

    # Создание таблицы Специальность
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS Специальность (
        КодСпециальности TEXT PRIMARY KEY,
        НаименованиеСпециальности TEXT NOT NULL
    )
    ''')

    # Создание таблицы Обучающийся
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS Обучающийся (
        Шифр INTEGER PRIMARY KEY,
        Фамилия TEXT NOT NULL,
        Имя TEXT NOT NULL,
        Отчество TEXT,
        КодСпециальности TEXT NOT NULL,
        Курс INTEGER NOT NULL,
        Группа INTEGER NOT NULL,
        ДатаРождения TEXT NOT NULL,
        Национальность TEXT,
        Адрес TEXT,
        FOREIGN KEY (КодСпециальности) REFERENCES Специальность(КодСпециальности)
    )
    ''')

    # Создание таблицы Успеваемость
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS Успеваемость (
        ID INTEGER PRIMARY KEY AUTOINCREMENT,
        Шифр INTEGER NOT NULL,
        Семестр INTEGER NOT NULL,
        Дисциплина TEXT NOT NULL,
        Оценка INTEGER NOT NULL CHECK(Оценка >= 2 AND Оценка <= 5),
        ДатаСдачи TEXT NOT NULL,
        ФИОПреподавателя TEXT NOT NULL,
        FOREIGN KEY (Шифр) REFERENCES Обучающийся(Шифр)
    )
    ''')

    conn.commit()
    print("✓ Таблицы успешно созданы")
    return conn, cursor


def fill_specialities(cursor):
    """Заполнение таблицы Специальность"""

    specialities = [
        ('23.03.01', 'Технология транспортных средств'),
        ('23.03.03', 'Эксплуатация транспортно-технологических машин и комплексов'),
        ('23.05.01', 'Наземные транспортно-технологические средства'),
        ('15.03.04', 'Автоматизация технологических процессов и производств')
    ]

    cursor.executemany(
        'INSERT OR IGNORE INTO Специальность VALUES (?, ?)',
        specialities
    )
    print(f"✓ Добавлено {len(specialities)} специальностей")


def fill_students(cursor):
    """Заполнение таблицы Обучающийся"""

    students = [
        (12121, 'Иванов', 'Герман', 'Олегович', '23.03.01', 1, 11, '19.07.1993', 'РФ', 'Серов, Ленина, 4-67'),
        (13131, 'Петров', 'Игнат', 'Ильич', '23.03.01', 1, 11, '20.06.1993', 'РФ', 'Тавда, Мира, 16-58'),
        (14141, 'Серова', 'Ольга', 'Игоревна', '23.03.01', 2, 21, '06.04.1992', 'Украина', 'Пермь, Седова, 4-1'),
        (15151, 'Ежов', 'Игорь', 'Павлович', '23.03.01', 3, 31, '07.08.1992', 'РФ', 'Сысерть, Майская, 9-24'),
        (16161, 'Смирнова', 'Марина', 'Ивановна', '23.03.01', 3, 31, '26.03.1990', 'Башкирия', 'Уфа, Гоголя, 98-37'),
        (17171, 'Волков', 'Антон', 'Сергеевич', '23.03.03', 3, 31, '11.09.1992', 'РФ', 'Екатеринбург, Крауля, 6-11'),
        (18181, 'Пастухов', 'Иван', 'Николаевич', '23.03.03', 3, 31, '27.10.1992', 'Украина', 'В.Пышма, Кирова, 7-12'),
        (19191, 'Чехов', 'Виктор', 'Юрьевич', '23.03.03', 4, 41, '31.07.1991', 'РФ', 'Туринск, Коммуны, 41'),
        (21212, 'Маркова', 'Юлия', 'Борисовна', '23.03.03', 4, 41, '01.12.1991', 'РФ', 'Серов, К-Маркса, 23-1'),
        (23232, 'Харлов', 'Алексей', 'Иванович', '23.05.01', 1, 111, '09.08.1993', 'РФ', 'В.Пышма, Черепанова, 35-89'),
        (24242, 'Бусыгин', 'Андрей', 'Федорович', '23.05.01', 3, 311, '21.09.1992', 'Украина',
         'Миасс, Мартьянова, 6-2'),
        (25252, 'Зыкова', 'Ольга', 'Сергеевна', '23.05.01', 3, 311, '02.06.1992', 'РФ', 'Пермь, Куйбышева, 9'),
        (26262, 'Валиулин', 'Ильяс', 'Юрьевич', '23.05.01', 4, 411, '15.07.1991', 'Башкирия', 'Уфа, Марата, 4-10'),
        (27272, 'Седышева', 'Татьяна', 'Семеновна', '15.03.04', 1, 12, '11.11.1993', 'РФ', 'Тавда, Мира, 18-2'),
        (28282, 'Бызова', 'Ирина', 'Павловна', '15.03.04', 1, 12, '15.02.1993', 'Башкирия', 'Уфа, Долорес, 12-23'),
        (29292, 'Маринина', 'Альбина', 'Алимовна', '15.03.04', 1, 12, '18.10.1993', 'Башкирия', 'Уфа, П.Морозова, 5-7'),
        (31313, 'Скрипин', 'Кирилл', 'Сергеевич', '15.03.04', 2, 22, '26.04.1992', 'РФ', 'Тавда, Бажова, 60-2'),
        (32323, 'Рыбин', 'Андрей', 'Ильич', '15.03.04', 2, 22, '14.02.1992', 'РФ', 'Серов, Н.Воли, 25-11'),
        (34343, 'Никулин', 'Юрий', 'Иванович', '15.03.04', 2, 22, '26.09.1992', 'РФ', 'Соликамск, Мира, 8-21'),
        (35353, 'Макаров', 'Олег', 'Николаевич', '15.03.04', 3, 33, '09.07.1992', 'РФ', 'Приобье, Профсоюзов, 3')
    ]

    cursor.executemany(
        'INSERT OR IGNORE INTO Обучающийся VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)',
        students
    )
    print(f"✓ Добавлено {len(students)} студентов")


def fill_performance(cursor):
    """Заполнение таблицы Успеваемость"""

    performance = [
        (12121, 1, 'История', 5, '12.01.2015', 'Пухов Д.Ю.'),
        (12121, 1, 'Химия', 4, '14.01.2015', 'Серова Е.Ю.'),
        (12121, 1, 'Математика', 4, '18.01.2015', 'Демидова И.Н.'),
        (13131, 1, 'История', 4, '12.01.2015', 'Пухов Д.Ю.'),
        (13131, 1, 'Химия', 3, '14.01.2015', 'Серова Е.Ю.'),
        (13131, 1, 'Математика', 4, '18.01.2015', 'Демидова И.Н.'),
        (14141, 3, 'Иностранный язык', 4, '19.01.2015', 'Васильева Д.А.'),
        (14141, 3, 'Физическая культура', 3, '21.01.2015', 'Жданова Ю.А.'),
        (15151, 5, 'Системы управления базами данных', 4, '22.01.2015', 'Голубев Н.А.'),
        (15151, 5, 'Общая теория транспортных систем', 5, '27.01.2015', 'Панычев А.П.'),
        (16161, 5, 'Системы управления базами данных', 4, '22.01.2015', 'Голубев Н.А.'),
        (16161, 5, 'Общая теория транспортных систем', 4, '27.01.2015', 'Панычев А.П.'),
        (17171, 5, 'Системы управления базами данных', 5, '22.01.2015', 'Голубев Н.А.'),
        (17171, 5, 'Общая теория транспортных систем', 5, '27.01.2015', 'Панычев А.П.'),
        (18181, 5, 'Системы управления базами данных', 3, '22.01.2015', 'Голубев Н.А.'),
        (18181, 5, 'Общая теория транспортных систем', 4, '27.01.2015', 'Панычев А.П.'),
        (19191, 7, 'БЖД', 4, '25.01.2015', 'Чумарный Г.В.'),
        (21212, 7, 'БЖД', 5, '25.01.2015', 'Чумарный Г.В.'),
        (23232, 1, 'Вычислительные системы и сети', 4, '14.01.2015', 'Голубев Н.А.'),
        (23232, 1, 'Математика', 5, '16.01.2015', 'Демидова И.Н.'),
        (24242, 5, 'Теоретическая механика', 4, '12.01.2015', 'Раевская Л.Т.'),
        (24242, 5, 'Диагностика транспортных средств', 4, '15.01.2015', 'Сидоров Б.А.'),
        (25252, 5, 'Теоретическая механика', 3, '12.01.2015', 'Раевская Л.Т.'),
        (25252, 5, 'Диагностика транспортных средств', 4, '15.01.2015', 'Сидоров Б.А.'),
        (26262, 7, 'Прикладное программирование', 3, '11.01.2015', 'Крайнова Т.С.'),
        (26262, 7, 'ЭВМ в проектировании процессов ТО', 4, '14.01.2015', 'Алексеева О.В.'),
        (27272, 1, 'Физика', 5, '17.01.2015', 'Чащина В.Г.'),
        (27272, 1, 'Начертательная геометрия', 4, '19.01.2015', 'Загребина Т.В.'),
        (27272, 1, 'История', 5, '12.01.2015', 'Пухов Д.Ю.'),
        (28282, 1, 'Физика', 5, '17.01.2015', 'Чащина В.Г.'),
        (28282, 1, 'Начертательная геометрия', 5, '19.01.2015', 'Загребина Т.В.'),
        (28282, 1, 'История', 5, '12.01.2015', 'Пухов Д.Ю.'),
        (29292, 1, 'Физика', 4, '17.01.2015', 'Чащина В.Г.'),
        (29292, 1, 'Начертательная геометрия', 3, '19.01.2015', 'Загребина Т.В.'),
        (29292, 1, 'История', 4, '12.01.2015', 'Пухов Д.Ю.'),
        (31313, 3, 'Алгоритмы и структуры данных', 4, '23.01.2015', 'Нохрина Г.Л.'),
        (31313, 3, 'Экология', 3, '26.01.2015', 'Первова И.Г.'),
        (31313, 3, 'Автоматика и кибернетика', 4, '30.01.2015', 'Санников А.А.'),
        (32323, 3, 'Алгоритмы и структуры данных', 3, '23.01.2015', 'Нохрина Г.Л.'),
        (32323, 3, 'Экология', 3, '26.01.2015', 'Первова И.Г.'),
        (32323, 3, 'Автоматика и кибернетика', 3, '30.01.2015', 'Санников А.А.'),
        (34343, 3, 'Алгоритмы и структуры данных', 5, '23.01.2015', 'Нохрина Г.Л.'),
        (34343, 3, 'Экология', 5, '26.01.2015', 'Первова И.Г.'),
        (34343, 3, 'Автоматика и кибернетика', 3, '30.01.2015', 'Санников А.А.'),
        (35353, 5, 'СУБД', 4, '02.02.2015', 'Голубев Н.А.'),
        (35353, 5, 'Робототехника', 5, '21.01.2015', 'Санников А.А.'),
        (35353, 5, 'Технологии программирования', 5, '23.01.2015', 'Крайнова Т.С.')
    ]

    cursor.executemany(
        'INSERT INTO Успеваемость (Шифр, Семестр, Дисциплина, Оценка, ДатаСдачи, ФИОПреподавателя) VALUES (?, ?, ?, ?, ?, ?)',
        performance
    )
    print(f"✓ Добавлено {len(performance)} записей успеваемости")


def show_statistics(cursor):
    """Вывод статистики по базе данных"""

    print("\n" + "=" * 60)
    print("СТАТИСТИКА БАЗЫ ДАННЫХ")
    print("=" * 60)

    # Количество специальностей
    cursor.execute('SELECT COUNT(*) FROM Специальность')
    print(f"Специальностей: {cursor.fetchone()[0]}")

    # Количество студентов
    cursor.execute('SELECT COUNT(*) FROM Обучающийся')
    print(f"Студентов: {cursor.fetchone()[0]}")

    # Количество записей успеваемости
    cursor.execute('SELECT COUNT(*) FROM Успеваемость')
    print(f"Записей успеваемости: {cursor.fetchone()[0]}")

    # Средний балл по всем студентам
    cursor.execute('SELECT AVG(Оценка) FROM Успеваемость')
    avg_grade = cursor.fetchone()[0]
    print(f"Средний балл: {avg_grade:.2f}")

    print("\n" + "=" * 60)
    print("ТОП-5 СТУДЕНТОВ ПО СРЕДНЕМУ БАЛЛУ")
    print("=" * 60)

    cursor.execute('''
        SELECT 
            о.Фамилия || ' ' || о.Имя || ' ' || о.Отчество AS ФИО,
            о.Группа,
            ROUND(AVG(у.Оценка), 2) AS СреднийБалл,
            COUNT(у.Оценка) AS КоличествоОценок
        FROM Обучающийся о
        JOIN Успеваемость у ON о.Шифр = у.Шифр
        GROUP BY о.Шифр
        ORDER BY СреднийБалл DESC
        LIMIT 5
    ''')

    for i, row in enumerate(cursor.fetchall(), 1):
        print(f"{i}. {row[0]} (группа {row[1]}) - {row[2]} (оценок: {row[3]})")


def main():
    """Главная функция"""

    print("=" * 60)
    print("ЛАБОРАТОРНАЯ РАБОТА 2")
    print("Создание и заполнение базы данных SQLite")
    print("=" * 60 + "\n")

    try:
        # Создание базы данных и таблиц
        conn, cursor = create_database()

        # Заполнение таблиц
        print("\nЗаполнение таблиц данными...")
        fill_specialities(cursor)
        fill_students(cursor)
        fill_performance(cursor)

        # Сохранение изменений
        conn.commit()
        print("\n✓ Все данные успешно сохранены в базе данных 'university.db'")

        # Вывод статистики
        show_statistics(cursor)

        # Закрытие соединения
        conn.close()
        print("\n✓ База данных успешно создана и заполнена!")

    except sqlite3.Error as e:
        print(f"\n✗ Ошибка при работе с базой данных: {e}")
    except Exception as e:
        print(f"\n✗ Непредвиденная ошибка: {e}")


if __name__ == '__main__':
    main()